<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e90ff">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morgan County Storm Shelter Guide</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .shelter-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .shelter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 0, 0.05);
        }
        /* Custom styling for the radar iframe container */
        .radar-container {
            width: 100%;
            height: 500px; /* Default height */
            /* Responsive adjustment for height on small screens */
            max-height: 70vh; 
        }
        /* Adjust iframe for full container size */
        .radar-container iframe {
            width: 100%;
            height: 100%;
        }
        /* Style for custom message box */
        #custom-message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            min-width: 250px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #custom-message-box.show {
            display: block;
            opacity: 1;
        }
        .message-success { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .message-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
        .message-warning { background-color: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }

        /* Language Toggle Switch */
        .lang-toggle {
            cursor: pointer;
            user-select: none;
        }
    </style>
    <script>
        // Data containing all shelter information with approximate geographical coordinates (Lat/Lng)
        // Note: Capacity values are placeholders and should be replaced with official figures.
        const shelterData = [
            { name: "Danville Volunteer Fire Dept", address: "5798 Hwy. 36 W", city: "Danville", zip: "35619", notes: "Fire Department Shelter", category: "VFD", lat: 34.3541, lng: -87.0543, capacity: 80 },
            { name: "Punkin Center Volunteer Fire Dept", address: "116 Kirby Bridge Road", city: "Danville", zip: "35619", notes: "Fire Department Shelter", category: "VFD", lat: 34.3312, lng: -87.0855, capacity: 75 },
            { name: "Massey Volunteer Fire Dept", address: "386 Evergreen Road", city: "Danville", zip: "35622", notes: "Fire Department Shelter", category: "VFD", lat: 34.4079, lng: -87.0701, capacity: 90 },
            { name: "Neel Volunteer Fire Dept", address: "70 Neel School Road", city: "Danville", zip: "35622", notes: "Fire Department Shelter", category: "VFD", lat: 34.4255, lng: -87.0688, capacity: 70 },
            { name: "Austin High School", address: "3004 Modaus Road", city: "Decatur", zip: "35603", notes: "School (Check local media for opening status)", category: "School", lat: 34.5639, lng: -87.0489, capacity: 500 },
            { name: "Somerville Community Shelter (1)", address: "192 Broad St.", city: "Somerville", zip: "35670", notes: "Community Building Shelter", category: "Community", lat: 34.4705, lng: -86.7999, capacity: 120 },
            { name: "Somerville Community Shelter (2)", address: "72 Cross Creek Loop", city: "Somerville", zip: "35670", notes: "Community Building Shelter", category: "Community", lat: 34.4687, lng: -86.7901, capacity: 110 },
            { name: "Hartselle High School", address: "1000 Bethel Road NE", city: "Hartselle", zip: "35640", notes: "School (Check local media for opening status)", category: "School", lat: 34.4533, lng: -86.9377, capacity: 600 },
            { name: "Brindlee Mountain Volunteer Fire Dept", address: "4373 U.S. Hwy. 231", city: "Union Grove", zip: "35175", notes: "Fire Department Shelter", category: "VFD", lat: 34.4370, lng: -86.3789, capacity: 65 },
            { name: "Eva Volunteer Fire Dept", address: "4238 Eva Road", city: "Eva", zip: "35621", notes: "Fire Department Shelter", category: "VFD", lat: 34.3585, lng: -86.7032, capacity: 85 },
            { name: "Cotaco Volunteer Fire Dept", address: "6463 Hwy. 36 East", city: "Somerville", zip: "35670", notes: "Fire Department Shelter", category: "VFD", lat: 34.4812, lng: -86.7210, capacity: 95 },
            { name: "Crestline Elementary School", address: "600 Crestline Drive SW", city: "Hartselle", zip: "35640", notes: "School (Check local media for opening status)", category: "School", lat: 34.4265, lng: -86.9348, capacity: 350 },
            { name: "Somerville VFD, Station 2", address: "122 Perkins Wood Road", city: "Hartselle", zip: "35640", notes: "Fire Department Shelter", category: "VFD", lat: 34.4445, lng: -86.9015, capacity: 60 },
            { name: "Decatur High School", address: "910 Somerville Road, SE", city: "Decatur", zip: "35601", notes: "School (Check local media for opening status)", category: "School", lat: 34.5931, lng: -86.9711, capacity: 450 },
            { name: "Trinity Town Hall", address: "35 Preston Drive", city: "Trinity", zip: "35673", notes: "Town Hall Shelter", category: "Community", lat: 34.6107, lng: -87.0855, capacity: 100 },
            { name: "Morgan County Courthouse Basement", address: "302 Lee St. N.E.", city: "Decatur", zip: "35602", notes: "Public Shelter - May offer 24-hour access", category: "Public", lat: 34.6047, lng: -86.9806, capacity: 300 },
            { name: "Flint City Volunteer Fire Department", address: "114 Oxmore Flint Rd SW", city: "Decatur", zip: "35603", notes: "Fire Department Shelter", category: "VFD", lat: 34.5651, lng: -87.0401, capacity: 120 },
            { name: "Priceville High School", address: "2650 North Bethel Road", city: "Priceville", zip: "35603", notes: "School (Check local media for opening status)", category: "School", lat: 34.5097, lng: -86.9038, capacity: 400 },
            { name: "Priceville Town Hall", address: "242 Marco Drive", city: "Priceville", zip: "35603", notes: "Town Hall Shelter", category: "Community", lat: 34.5122, lng: -86.9115, capacity: 150 },
            { name: "Shorty Ryan Park", address: "3824 Eva Road", city: "Eva", zip: "35621", notes: "Community Building Shelter", category: "Community", lat: 34.3571, lng: -86.7025, capacity: 130 },
            { name: "Oak Ridge VFD Station 1", address: "200 NW Simmons Road", city: "Hartselle", zip: "35640", notes: "Fire Department Shelter", category: "VFD", lat: 34.4601, lng: -86.9055, capacity: 55 },
            { name: "Oak Ridge VFD Station 2", address: "2580 Vaughn Bridge Rd", city: "Hartselle", zip: "35640", notes: "Fire Department Shelter", category: "VFD", lat: 34.4650, lng: -86.8499, capacity: 85 },
            { name: "Decatur City Hall - Basement", address: "402 Lee St NE", city: "Decatur", zip: "35601", notes: "Public Shelter - May offer 24-hour access", category: "Public", lat: 34.6085, lng: -86.9805, petFriendly: true, capacity: 250 },
            { name: "Tri-County VFD", address: "11667 Hwy 67 South", city: "Joppa", zip: "35087", notes: "Fire Department Shelter", category: "VFD", lat: 34.4011, lng: -86.6872, capacity: 70 }
        ];

        // Global variable to hold user's current location
        let userLocation = null;
        let currentLang = 'en'; // 'en' or 'es'

        // --- TRANSLATION DICTIONARIES ---

        const uiTranslations = {
            en: {
                title: "Morgan County Area Emergency Shelters",
                subtitle: "A vital resource for Hartselle and surrounding communities.",
                disclaimer: "**OFFICIAL DISCLAIMER:** The Morgan County Commission, its departments, officers, employees, representatives, and agents are not responsible for the information provided on this website and make no representations as to the accuracy of the information provided herein.",
                safetyText: "Always be prepared. View essential storm safety and emergency planning resources.",
                safetyBtn: "View Safety Guide",
                radarTitle: "Morgan County Live Weather Radar",
                radarText: "This is a live radar view centered on North Alabama. Use this to track storms. **Note:** Radar data is provided by the National Weather Service (NWS) and may take a moment to load.",
                searchPlaceholder: "Search by name, road, or city...",
                allCities: "All Cities",
                petFriendlyOption: " Pet Friendly Shelters",
                locationBtnDefault: "Use My Location to Sort by Closest",
                locationBtnFound: "Resort by My Location",
                locationStatusFinding: "Finding your location...",
                locationStatusFound: "Location found! Shelters sorted by distance.",
                locationStatusError: "Location error. Please check browser permissions.",
                noSheltersTitle: "No shelters match your search criteria.",
                noSheltersText: "Try broadening your search or selecting 'All Cities'.",
                footerDev: "Developed as a community service project by Hartselle students.",
                footerOfficial: "For official emergency information, contact: Morgan County EMA or the City of Hartselle.",
                getDirections: "Get Directions (Map)",
                milesAway: "miles away",
                estCapacity: "Est. Capacity",
                people: "people",
                petsOk: "Pets OK",
                vfd: "VFD/Fire Station"
            },
            es: {
                title: "Refugios de Emergencia del Condado de Morgan",
                subtitle: "Un recurso vital para Hartselle y las comunidades circundantes.",
                disclaimer: "**AVISO OFICIAL:** La Comisi贸n del Condado de Morgan, sus departamentos, funcionarios, empleados, representantes y agentes no son responsables de la informaci贸n proporcionada en este sitio web y no hacen declaraciones sobre la exactitud de la informaci贸n aqu铆 proporcionada.",
                safetyText: "Siempre est茅 preparado. Vea recursos esenciales de seguridad para tormentas.",
                safetyBtn: "Ver Gu铆a de Seguridad",
                radarTitle: "Radar Meteorol贸gico en Vivo del Condado de Morgan",
                radarText: "Esta es una vista de radar en vivo centrada en el norte de Alabama. selo para rastrear tormentas. **Nota:** Los datos del radar son proporcionados por el Servicio Meteorol贸gico Nacional (NWS) y pueden tardar un momento en cargarse.",
                searchPlaceholder: "Buscar por nombre, calle o ciudad...",
                allCities: "Todas las Ciudades",
                petFriendlyOption: " Refugios que Aceptan Mascotas",
                locationBtnDefault: "Usar mi ubicaci贸n para ordenar por cercan铆a",
                locationBtnFound: "Reordenar por mi ubicaci贸n",
                locationStatusFinding: "Buscando su ubicaci贸n...",
                locationStatusFound: "隆Ubicaci贸n encontrada! Refugios ordenados por distancia.",
                locationStatusError: "Error de ubicaci贸n. Por favor revise los permisos del navegador.",
                noSheltersTitle: "Ning煤n refugio coincide con sus criterios de b煤squeda.",
                noSheltersText: "Intente ampliar su b煤squeda o seleccionar 'Todas las Ciudades'.",
                footerDev: "Desarrollado como un proyecto de servicio comunitario por estudiantes de Hartselle.",
                footerOfficial: "Para informaci贸n oficial de emergencia, contacte: EMA del Condado de Morgan o la Ciudad de Hartselle.",
                getDirections: "Obtener Direcciones (Mapa)",
                milesAway: "millas de distancia",
                estCapacity: "Cap. Est.",
                people: "personas",
                petsOk: "Mascotas OK",
                vfd: "Estaci贸n de Bomberos/VFD"
            }
        };

        const noteTranslations = {
            "Fire Department Shelter": "Refugio del Departamento de Bomberos",
            "School (Check local media for opening status)": "Escuela (Verifique medios locales para estado de apertura)",
            "Community Building Shelter": "Refugio del Edificio Comunitario",
            "Town Hall Shelter": "Refugio del Ayuntamiento",
            "Public Shelter - May offer 24-hour access": "Refugio P煤blico - Puede ofrecer acceso las 24 horas"
        };

        const categoryTranslations = {
            "VFD": "Bomberos",
            "School": "Escuela",
            "Community": "Comunidad",
            "Public": "P煤blico"
        };

        // --- END TRANSLATIONS ---

        // Haversine formula to calculate the distance between two points on the globe
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Radius of the Earth in miles
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in miles
            return distance;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'es' : 'en';
            updateStaticText();
            // Re-render filters to update dropdown options
            setupFilters(true); // Pass true to indicate update vs initial setup
            applyFilters(); // Re-render cards
        }

        function getText(key) {
            return uiTranslations[currentLang][key] || key;
        }

        function updateStaticText() {
            document.documentElement.lang = currentLang;
            
            // Text Content Updates
            document.getElementById('header-title').textContent = getText('title');
            document.getElementById('header-subtitle').textContent = getText('subtitle');
            document.getElementById('header-disclaimer').textContent = getText('disclaimer');
            document.getElementById('safety-text').textContent = getText('safetyText');
            document.getElementById('safety-btn-text').textContent = getText('safetyBtn');
            document.getElementById('radar-title-text').textContent = getText('radarTitle');
            document.getElementById('radar-desc').textContent = getText('radarText');
            document.getElementById('search-input').placeholder = getText('searchPlaceholder');
            
            // Location button logic needs check state
            const locBtn = document.getElementById('sort-by-location-btn');
            if (userLocation) {
                locBtn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a4 4 0 115.656-5.656l1.414 1.414 1.414-1.414a4 4 0 015.656 5.656z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10a2 2 0 100-4 2 2 0 000 4z"></path></svg> ${getText('locationBtnFound')}`;
            } else {
                locBtn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a4 4 0 115.656-5.656l1.414 1.414 1.414-1.414a4 4 0 015.656 5.656z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10a2 2 0 100-4 2 2 0 000 4z"></path></svg> ${getText('locationBtnDefault')}`;
            }

            document.getElementById('footer-dev').textContent = getText('footerDev');
            document.getElementById('footer-official').textContent = getText('footerOfficial');
            
            // Toggle Button Text
            const toggleBtn = document.getElementById('lang-toggle-btn');
            toggleBtn.innerHTML = currentLang === 'en' 
                ? 'Espa帽ol <span class="ml-2"></span>' 
                : 'English <span class="ml-2">吼</span>';
        }

        // Function to handle geolocation and sort shelters
        function getUserLocationAndSort() {
            const statusMessage = document.getElementById('location-status');
            const button = document.getElementById('sort-by-location-btn');
            
            if (!navigator.geolocation) {
                statusMessage.textContent = 'Geolocation is not supported by your browser.';
                statusMessage.classList.remove('hidden');
                return;
            }

            // Disable button and show loading status
            button.disabled = true;
            statusMessage.textContent = getText('locationStatusFinding');
            statusMessage.classList.remove('hidden', 'text-red-500', 'text-green-600', 'text-red-500');
            statusMessage.classList.add('text-blue-500');

            navigator.geolocation.getCurrentPosition((position) => {
                // Success
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                statusMessage.textContent = getText('locationStatusFound');
                statusMessage.classList.remove('text-blue-500', 'text-red-500');
                statusMessage.classList.add('text-green-600');
                
                // Update button text using translation
                button.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a4 4 0 115.656-5.656l1.414 1.414 1.414-1.414a4 4 0 015.656 5.656z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10a2 2 0 100-4 2 2 0 000 4z"></path></svg> ${getText('locationBtnFound')}`;
                
                button.disabled = false;

                // Re-render shelters with the new location data
                applyFilters();

            }, (error) => {
                // Error handling
                button.disabled = false;
                button.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a4 4 0 115.656-5.656l1.414 1.414 1.414-1.414a4 4 0 015.656 5.656z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10a2 2 0 100-4 2 2 0 000 4z"></path></svg> ${getText('locationBtnDefault')}`;

                let errorText = getText('locationStatusError');
                if (error.code === error.PERMISSION_DENIED) {
                   // Keep generic error for simplicity in translation, or add specific keys
                }

                statusMessage.textContent = errorText;
                statusMessage.classList.remove('hidden', 'text-blue-500', 'text-green-600');
                statusMessage.classList.add('text-red-500');
                userLocation = null; // Clear location if there was an error
                applyFilters(); // Re-render without sorting by distance
            });
        }

        // Function to display a custom message box instead of alert()
        function alertMessage(message, type = 'success') {
            const box = document.getElementById('custom-message-box');
            const content = document.getElementById('message-content');
            
            box.className = 'message-box'; // Reset classes
            box.classList.add('show', `message-${type}`);
            content.textContent = message;
            
            // Hide after 4 seconds
            setTimeout(() => {
                box.classList.remove('show');
            }, 4000);
        }

        // Function to render the shelter cards based on search/filter/location
        function renderShelters(filters = {}) {
            const container = document.getElementById('shelter-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous results

            let filteredShelters = shelterData.filter(shelter => {
                const searchTerm = filters.search ? filters.search.toLowerCase() : '';
                const filterCity = filters.city ? filters.city.toLowerCase() : 'all';

                // 1. Check search term (name, address, notes, city)
                const matchesSearch = searchTerm === '' ||
                    shelter.name.toLowerCase().includes(searchTerm) ||
                    shelter.address.toLowerCase().includes(searchTerm) ||
                    shelter.notes.toLowerCase().includes(searchTerm) ||
                    shelter.city.toLowerCase().includes(searchTerm);

                // 2. Check city filter OR pet friendly filter
                let matchesCityOrPet = false;
                if (filterCity === 'all') {
                    matchesCityOrPet = true;
                } else if (filterCity === 'pet-friendly') {
                    matchesCityOrPet = shelter.petFriendly === true;
                } else {
                    matchesCityOrPet = shelter.city.toLowerCase() === filterCity;
                }

                return matchesSearch && matchesCityOrPet;
            });

            // 3. Calculate distance and sort if userLocation is available
            if (userLocation) {
                filteredShelters.forEach(shelter => {
                    shelter.distance = getDistance(
                        userLocation.lat, userLocation.lng,
                        shelter.lat, shelter.lng
                    );
                });
                
                // Sort by distance (ascending)
                filteredShelters.sort((a, b) => a.distance - b.distance);
            } else {
                // Remove distance property and sort alphabetically by name if no location is available
                filteredShelters.forEach(shelter => delete shelter.distance);
                filteredShelters.sort((a, b) => a.name.localeCompare(b.name));
            }


            if (filteredShelters.length === 0) {
                container.innerHTML = `
                    <div class="md:col-span-4 p-6 text-center text-gray-500 bg-white rounded-xl shadow-inner mt-8 w-full">
                        <p class="text-lg font-semibold">${getText('noSheltersTitle')}</p>
                        <p class="text-sm">${getText('noSheltersText')}</p>
                    </div>
                `;
                container.style.gridTemplateColumns = '1fr';
                return;
            }

            container.style.gridTemplateColumns = '';

            filteredShelters.forEach(shelter => {
                // Corrected map link generation for Google Maps search
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${shelter.address}, ${shelter.city}, AL ${shelter.zip}`)}`;

                // Determine color based on category
                let categoryColor = 'bg-blue-100 text-blue-800 border-blue-600';
                if (shelter.category === 'School') categoryColor = 'bg-yellow-100 text-yellow-800 border-yellow-600';
                if (shelter.category === 'Public') categoryColor = 'bg-red-100 text-red-800 font-bold border-red-600';
                if (shelter.category === 'VFD') categoryColor = 'bg-green-100 text-green-800 border-green-600';
                if (shelter.category === 'Community') categoryColor = 'bg-purple-100 text-purple-800 border-purple-600';

                // Display distance if available
                const distanceDisplay = shelter.distance !== undefined ?
                    `<p class="mt-2 text-md font-extrabold text-gray-900"><span class="text-green-600">憋</span> ${shelter.distance.toFixed(1)} ${getText('milesAway')}</p>` :
                    '';
                
                // Capacity Badge
                const capacityBadge = shelter.capacity ? 
                    `<p class="mt-1 text-sm text-gray-700 font-semibold flex items-center">
                        <svg class="w-4 h-4 mr-1 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5m0 0l-1.58-1.58M17 20l-1.58-1.58M17 20l-1.58-1.58M12 11h.01M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg>
                        ${getText('estCapacity')}: ${shelter.capacity} ${getText('people')}
                    </p>` : '';

                // Pet Friendly Badge
                const petFriendlyBadge = shelter.petFriendly ? 
                    `<span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-pink-100 text-pink-800 border border-pink-600 mr-2">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M12 20.5a8.5 8.5 0 100-17 8.5 8.5 0 000 17z"></path></svg>
                        ${getText('petsOk')}
                    </span>` : '';

                // Category Badge Translation
                const displayCategory = currentLang === 'es' 
                    ? (categoryTranslations[shelter.category] || shelter.category) 
                    : (shelter.category === 'VFD' ? getText('vfd') : shelter.category);

                const categoryBadge = `
                    <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${categoryColor.replace('border-', 'bg-').replace('100', '200')}">
                        ${displayCategory}
                    </span>
                `;

                // Note Translation
                const displayNote = currentLang === 'es' 
                    ? (noteTranslations[shelter.notes] || shelter.notes) 
                    : shelter.notes;


                const cardHtml = `
                    <div class="shelter-card bg-white p-6 rounded-2xl shadow-lg border-t-4 ${categoryColor} flex flex-col justify-between">
                        <div>
                            <div class="mb-3 flex flex-wrap items-center">
                                ${petFriendlyBadge}
                                ${categoryBadge}
                            </div>
                            ${distanceDisplay}
                            ${capacityBadge}
                            <h3 class="text-xl font-extrabold text-gray-900 mb-2">${shelter.name}</h3>
                            <p class="text-sm text-gray-600">${shelter.address}, ${shelter.city}, AL ${shelter.zip}</p>
                            <p class="mt-3 text-sm italic text-gray-700 font-medium">${displayNote}</p>
                        </div>
                        <div class="mt-4">
                            <a href="${mapLink}" target="_blank" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                                ${getText('getDirections')}
                                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a4 4 0 115.656-5.656l1.414 1.414 1.414-1.414a4 4 0 015.656 5.656z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.5 12a8.5 8.5 0 11-17 0 8.5 8.5 0 0117 0z"></path></svg>
                            </a>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        // Central function to apply all filters and render
        function applyFilters() {
             const searchInput = document.getElementById('search-input');
             const cityFilter = document.getElementById('city-filter');
             const filters = {
                 search: searchInput.value,
                 city: cityFilter.value
             };
             renderShelters(filters);
        }

        // Setup for filtering and searching. 
        // isUpdate param is used when switching languages to preserve selection but translate text
        function setupFilters(isUpdate = false) {
            const searchInput = document.getElementById('search-input');
            const cityFilter = document.getElementById('city-filter');
            const locationButton = document.getElementById('sort-by-location-btn');
            
            // Store current selection if updating
            const currentSelection = cityFilter.value;

            // Populate City Filter options dynamically
            const cities = [...new Set(shelterData.map(s => s.city))].sort();
            
            // Clear existing options
            cityFilter.innerHTML = '';

            // Add 'All Cities' option explicitly first
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = getText('allCities');
            cityFilter.appendChild(allOption);

            // Add the 'Pet Friendly' option
            const petFriendlyOption = document.createElement('option');
            petFriendlyOption.value = 'pet-friendly';
            petFriendlyOption.textContent = getText('petFriendlyOption');
            cityFilter.appendChild(petFriendlyOption);

            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.toLowerCase();
                option.textContent = city;
                cityFilter.appendChild(option);
            });

            // Restore selection or default to all
            if (isUpdate) {
                // If the previous selection was valid, keep it. Otherwise default to 'all'.
                // Since values (city names) don't change translation, we can safely re-assign.
                // Exception: 'all cities' value is just 'all', so it works.
                cityFilter.value = currentSelection; 
            }

            if (!isUpdate) {
                // Event listeners only need to be attached once
                searchInput.addEventListener('input', applyFilters);
                cityFilter.addEventListener('change', applyFilters);
                locationButton.addEventListener('click', getUserLocationAndSort);
                
                // Toggle Button Listener
                document.getElementById('lang-toggle-btn').addEventListener('click', toggleLanguage);
            }
            
            // Initial render
            applyFilters();
        }

    </script>
</head>
<body class="p-4 sm:p-8">

    <!-- Custom message box for alerts -->
    <div id="custom-message-box" class="hidden" role="alert">
        <p id="message-content" class="font-medium"></p>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Language Toggle (Top Right) -->
        <div class="flex justify-end mb-4">
            <button id="lang-toggle-btn" class="lang-toggle inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Espa帽ol <span class="ml-2"></span>
            </button>
        </div>

        <!-- Header -->
        <header class="text-center mb-6 p-6 bg-white rounded-2xl shadow-xl border-b-4 border-red-600">
            <h1 id="header-title" class="text-3xl sm:text-5xl font-extrabold text-gray-800">Morgan County Area Emergency Shelters</h1>
            <p id="header-subtitle" class="mt-2 text-lg text-red-600 font-semibold">A vital resource for Hartselle and surrounding communities.</p>
            <!-- UPDATED DISCLAIMER PARAGRAPH BELOW -->
            <p id="header-disclaimer" class="mt-4 text-sm text-gray-600 max-w-2xl mx-auto font-medium">
                **OFFICIAL DISCLAIMER:** The Morgan County Commission, its departments, officers, employees, representatives, and agents are not responsible for the information provided on this website and make no representations as to the accuracy of the information provided herein.
            </p>
            <!-- END UPDATED DISCLAIMER -->
        </header>

        <!-- Emergency Planning Link (Replaces former TM link) -->
        <div class="mb-8">
            <div class="bg-indigo-700 p-5 rounded-2xl shadow-xl flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
                <p id="safety-text" class="text-white text-lg font-semibold text-center sm:text-left">
                    Always be prepared. View essential storm safety and emergency planning resources.
                </p>
                <!-- Placeholder URL for a general emergency resource -->
                <a href="https://www.ready.gov/kit" target="_blank" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-bold rounded-xl shadow-lg text-indigo-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="safety-btn-text">View Safety Guide</span>
                </a>
            </div>
        </div>

        <!-- Live Weather Radar Section -->
        <div class="mb-8 p-6 bg-white rounded-2xl shadow-xl border-t-4 border-blue-600">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <span id="radar-title-text">Morgan County Live Weather Radar</span>
            </h2>
            <p id="radar-desc" class="text-sm text-gray-600 mb-3">
                This is a live radar view centered on North Alabama. Use this to track storms.
                **Note:** Radar data is provided by the National Weather Service (NWS) and may take a moment to load.
            </p>
            <div class="radar-container rounded-xl overflow-hidden shadow-inner border border-gray-300">
                <!-- Using the NWS Huntsville (KHTX) radar with a map-only view for best embedding stability -->
                <iframe 
                    src="https://radar.weather.gov/station/KHTX/standard" 
                    frameborder="0" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>
        
        <!-- Search and Filter Controls -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
            
            <div class="md:col-span-2">
                <label for="search-input" class="sr-only">Search Shelters</label>
                <input type="text" id="search-input" placeholder="Search by name, road, or city..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500 shadow-sm text-gray-700" />
            </div>

            <div class="md:col-span-1">
                <label for="city-filter" class="sr-only">Filter by City</label>
                <select id="city-filter" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500 shadow-sm text-gray-700 bg-white">
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <div class="md:col-span-2 flex flex-col items-center">
                <button id="sort-by-location-btn"
                        class="w-full inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-xl shadow-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0L6.343 16.657a4 4 0 115.656-5.656l1.414 1.414 1.414-1.414a4 4 0 015.656 5.656z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                    Use My Location to Sort by Closest
                </button>
                <p id="location-status" class="text-xs mt-1 font-semibold text-center hidden"></p>
            </div>
        </div>

        <!-- Shelter Grid Container -->
        <div id="shelter-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Shelter cards will be injected here by JavaScript -->
        </div>

        <!-- Footer / Contact Info -->
        <footer class="mt-12 p-6 text-center text-gray-500 text-sm">
            <p id="footer-dev">Developed as a community service project by Hartselle students.</p>
            <p id="footer-official" class="mt-1">For official emergency information, contact: Morgan County EMA or the City of Hartselle.</p>
        </footer>
    </div>

    <!-- Firebase SDK Imports and Initialization Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        let db = null;
        let auth = null;
        let currentUserId = 'anonymous';
        let appId = 'default-app-id';

        // --- Firebase Initialization (Kept simple to ensure setupFilters runs after environment is ready) ---

        async function setupFirebase() {
            try {
                // Retrieve global variables
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in logic
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be confirmed
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Firebase initialized. User ID:", currentUserId);
                        setupFilters(); 
                    } else {
                        currentUserId = 'anonymous-error';
                        setupFilters();
                    }
                });

            } catch (error) {
                console.error("Fatal Error setting up Firebase:", error);
                alertMessage("Use The Get Directions button for the best results", "error");
                // Fallback: run filters even if Firebase failed
                setupFilters(); 
            }
        }
        
        // Start the application setup
        window.onload = setupFirebase;
    </script>

</body>
</html>
